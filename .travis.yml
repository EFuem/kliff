os: linux
sudo: required
language: python
dist: xenial

python:
  - "3.5"
  - "3.6"
  - "3.7"


before_install:
  # gcc (gfortran is not there by default, we install all gcc suit just in case)
  - sudo apt-get install gcc
  - sudo apt-get install gfortran

  # keep record of kliff directory
  - export KLIFF_DIR=$PWD
  - export KIM_API_VERSION=v2-2.0.1



install:
  # kim-api
  - cd $KLIFF_DIR && cd ..
  - wget http://s3.openkim.org/kim-api/kim-api-$KIM_API_VERSION.txz
  - tar Jxvf kim-api-$KIM_API_VERSION.txz
  - cd kim-api-$KIM_API_VERSION
  - mkdir build
  - cd build
  - cmake .. -DCMAKE_BUILD_TYPE=Release
  - sudo make install
  - sudo ldconfig
  # install SW driver and model
  - kim-api-v2-collections-management install user SW__MD_335816936951_004
  - kim-api-v2-collections-management install user SW_StillingerWeber_1985_Si__MO_405512056662_005

  # kimpy
  - pip install kimpy


# use doctr to build docs
env:
      global:
        # Doctr deploy key for mjwen/kliff
        - secure: "uDJ8fl/ioiC8mk1wgzphZf6P6OJXrgKLg9jDT1b1BBPNl+2C/tdlBMcKxjJYl8Ud+FI/Krdj0SWD1ueKyvQg7m7J9Gz1BZ9mddbmDMnT0F14zJZ9196gnbTGd+CpiGI9dBzLZgpT1t/DGvizWpIGTgNFMNzkrBICD7+iAxa546+PEGWyIXHb8tXxqi9xARUQbdwpkO5MiwlAiakaZKROwMjY03QJOflJzKKExgGMQx3aK9TMmebkhngaeMPgUxeClVeG5DXKGuwWGkQpUrLiHZt+dHTO7B1u3JcJa1ZguGmNH6ajOWr0jq/bHy2HtVoghhpG/odneRo8xwZLWDnzsjobEJJqV2n3e0myMevSZd+pOADEWxo+0hwdbArDgpewPdg56e5mh9mc4zCXi3oqnPFsHlLDel+JYmZauTIasE5QAQ/8Agt4DkEvxtI70idpUdIcKR4wTlj7EMi44nOYc29Hqv9EqF7h8pYI3Rqb072BrA13gmJaKm/D2ymHEQllYGTlCUn1ZlTzz4/f+PooedRQpKYw942R+PcbkD9FaYcCBIu4edDURW43QfqKpML0VFJJlk0Mq57KN01smvut3zId9yHzzCr/5dueT6H+tPIM0ZeKQSUNQnw5c1E5aVl5dhtFqrD5RC6q1P3h5VTIVWOLYrNjcc98JcfQXKJZEQM="


script:
  - cd $KLIFF_DIR
  - pip install -e .
  - cd tests
  - pytest test_neighbor.py
  - cd dataset
  - pytest
  - cd ../models
  - pytest
  - cd ../descriptors
  - pytest test_descriptor.py
  - pytest test_symmetry_function.py

# build and deploy doc
  - set -e
  # build docs
  - pip install sphinx
  - pip install sphinx-rtd-theme
  - cd $KLIFF_DIR/docs
  - make html
  - pip install doctr
  - cd $KLIFF_DIR
  - doctr deploy ./docs --built-docs $KLIFF_DIR/docs/build/html
